---
layout: post
title: "https"
subtitle: ""
date: 2019-07-29 12:00:00
author: "左手喝水"
header-img: "img/post-bg-2015.jpg"
tags:
  - 网络
---
## https流程

![https](/blog/img/in-post/https/https-process.png){:height="70%" width="70%"}

<center style="color:#999"> https流程 </center>

1. 客户端向服务端发起请求
2. 服务端接受到请求向 CA 发送【服务端共钥】+服务端相关信息
3. CA 根据提供的信息使用【CA 私钥】加密生成证书，证书包含【CA 私钥】加密过的【服务端共钥】、【CA 私钥】加密过的数字签名、信息摘要
4. 证书签发给服务端
5. 服务端把证书发给客户端
6. 客户端验证证书，查看证书 CA 机构找到对应的【CA 共钥】（【CA 的共钥】浏览器已经内置）。使用【CA 共钥】解开数字签名，根据证书的使用哈希算法比对解密后的签名， 一致则认为证书有效然后解密获得【服务端共钥】。
7. 客户端使用【服务端共钥】加密【客户端私钥】发送给服务端
8. 服务端接受到【客户端私钥】后使用私钥通信

非对称解密有共钥私钥一对密钥，公钥加密只有私钥能解开，反过来一样
CA 密钥：非对称共私密钥一对  
服务端密钥：非对称公私密钥一对
客户端密钥：对称私钥

Qusetion：

1. 中间人伪造签名怎么办
   签名被【CA 私钥】加密，即使使用【CA 共钥】解密，但是只有 CA 机构知道【CA 密钥】所以篡改后无法重新签名，通不过客户端验证

2. 中间人篡改信息怎么办
   客户端接受到后会把信息摘要进行哈希算法和解密后端签名比对，信息不一致则发现篡改不接受请求。修改签名的话需要重新加密，同样没有【CA 私钥】无法加密

## 浏览器什么时候请求http和https

当得到当请求头有`Strict-Transport-Security`，以后该域名请求都使用HTTPS  
这种情况在一次请求的时候还是HTTP所有有被中间人攻击的可能  
这种情况有谷歌的HTST预加载服务，这是一个是谷歌运维的HTTPS域名列表，请求的时候会先去预加载服务查询是否有注册过域名，如果有就直接HTTPS请求，目前大部分浏览器都会有该操作

参考：  
漫画：什么是 HTTPS 协议？<https://juejin.im/post/5c889918e51d45346459994d>
看完这篇文章，我奶奶都懂了 https 的原理 <https://www.cnblogs.com/sujing/p/10927569.html>
百度百科 HSTS：<https://baike.baidu.com/item/HSTS>
MDN HSTS:<https://developer.mozilla.org/zh-CN/docs/Security/HTTP_Strict_Transport_Security>
