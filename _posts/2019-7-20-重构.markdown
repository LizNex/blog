---
layout: post
title: "重构 改善即有代码的设计 第二版 第一章"
subtitle: ""
date: 2019-07-20 12:00:00
author: "左手喝水"
header-img: "img/post-bg-2015.jpg"
tags:
  - 重构
---

## 重构 改善即有代码的设计 第二版 第一章

第一章是一个重构的示例，演示怎么把结构组织较差的代码改进结构、分解功能点、最终多态提供扩展性让以后再继续扩展业务变的极为方便

## 第一阶段 调整结构

第一阶段把原本结构较差的代码重新组织使用了以下方法

- 加入测试保证重构过程保持原函数功能、输出正确。
- 将不同功能的函数抽离出来作为原函数的子函数。
- 去除多余的局部变量，使用函数返回代替获得取值。好处在于局部变量越少越利于重构。
- 内嵌函数不应该直接使用顶部函数作用域中的变量，而是应该以传值的方式传入参数。好处在于避免不显示的使用非函数本作用域的变量引起难以预测的变量修改
- 内嵌函数不直接修改上层函数的变量
- 合适的函数、参数命名
- 拆分循环让函数的目的更容易理解

## 第二阶段 拆分阶段

在新加入 html 输出的需求后将原来的函数拆分为

1. 创建中转数据
2. 打印账单/输出 html

这样的好处在于如果增加其他格式的输出只需要根据中转数据的格式来完成输出就好，代码的结构更加清晰，每个功能都被很好的区分，代码直接职责分割明确，将来维护起来哪个功能出现问题只要找对应的功能函数就好了

## 第三阶段

在第二阶段的基础上加入新增其他剧目类型的需求，原来剧目之间不同都是通过函数的条件判断来完成。现在使用多态来完成这一功能，做了如下操作

- 将所有关于剧目的计算信息创建一个类
- 不同剧目继承基类复写此剧目特殊的计算方式如：积分计算、总收入计算。个性化的东西都写在了每个类中
- 使用工厂函数来区分需要输出的什么类型的实例

这样做的好处在于如果以后需要添加其他剧目的时候只需要添加相应的类就可以了
